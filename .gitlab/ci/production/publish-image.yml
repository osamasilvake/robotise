publish-image:
  stage: Publish Image
  script:
    # Get app version
    - export APP_VERSION=$(./version.sh package.json)
    - echo $APP_VERSION

    # publish to GCP container registry
    - docker load -i images/release.tar
    - cat $GCP_CR_SERVICE_ACCOUNT_KEY | docker login -u _json_key --password-stdin "https://$GCP_CONTAINER_REGISTRY_HOSTNAME"
    
    # Latest version
    - docker tag release "$GCP_CONTAINER_REGISTRY_HOSTNAME/$GCP_PROJECT/$CI_PROJECT_NAME:latest"
    - docker push "$GCP_CONTAINER_REGISTRY_HOSTNAME/$GCP_PROJECT/$CI_PROJECT_NAME:latest"
    
    # Semantic version
    - docker tag release "$GCP_CONTAINER_REGISTRY_HOSTNAME/$GCP_PROJECT/$CI_PROJECT_NAME:$APP_VERSION"
    - docker push "$GCP_CONTAINER_REGISTRY_HOSTNAME/$GCP_PROJECT/$CI_PROJECT_NAME:$APP_VERSION"
  environment:
    name: production
  only:
    - production